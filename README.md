# Server
c/s Qt

该实现针对C/S客户端-服务集群应用需求而搭建。连接监听、数据传输、数据处理均在独立的线程池中进行，根据特定任务不同，可安排负责监听、传输、处理的线程数目，从而在高传输负荷、高计算符合上达成取舍。数据处理采用流水线结构，以避免少量客户的密集计算请求影响其他客户端的处理。本文对应的代码符合LGPL协议
     一、综述
       在许多行业应用中，客户端-服务架构不可替代。在客户端-服务架构下，服务扮演着重要的角色。本文旨在介绍一种较为通用的服务实现形式，这个形式可以根据具体应用需求灵活配置，从而减少重复开发的时间。该服务实现至少支持下列两种需求。
       第一类是转发型服务，主要负责沟通两个客户端之间的通信，本身不做复杂的处理。这种服务一般要承受密集的连接，在某些应用中，还要承受沉重的传输负荷。典型的包括即时通信、两个内网之间的视频通信等。
        第二类是计算型服务，主要负责接收客户端的原始数据，处理后把结果返回。这种服务一般运行在高性能服务器上，调用后台的并行计算、异构计算资源，处理后把结果返回给客户端。这些服务的客户端数量一般不多，但在某些应用中，当输入输出数据量大时，传输负荷也很重。
为了满足上述两类需求，服务设计具备如下特点。
        1、  可灵活设置监听端口
        2、  监听、传输、处理均在独立的线程池中运行。
        3、  可根据需要，灵活设置传输、处理线程的数目。
        4、  对某个单一客户端的处理，不会显著拖慢所有客户端的响应。
        5、  需要支持分布式的集群服务，典型的情况是基于若干物理计算机构成的高速局域网实现进程集群。
这些特点决定了本系统的架构设计。


1、  网络传输模块。负责管理用于监听、传输的套接字，并控制数据流在不同线程中流动。数据收发由一定规模的线程池负责，实现方法完全得益于Qt的线程事件循环。被绑定到某个Qthread上的Qobject对象，其信号-槽事件循环由该线程负责。这样，便可方便的指定某个套接字对象使用的线程。同样，受惠于Qt的良好封装，直接支持Tcp套接字及SSL套接字，且在运行时可动态调整。（注：编译这个模块需要Qt的SSL支持，即在 configure 时加入  -openssl 选项）
2、  任务流水线模块。负责数据的处理。在计算密集型的应用中，数据处理负荷较重，需要和网络传输划分开。基于普通线程池的处理模式，也存在队列阻塞的问题——若干个客户端请求的耗时操作，阻塞了其他客户端的响应，哪怕其他客户端的请求很短时间就能处理完毕，也必须排队等待。采用流水线线程池避免了这个问题。每个客户端把需要做的操作进行粒度化，在一个环形的队列中，线程池对单个客户端，每次仅处理一个粒度单位的任务。单个粒度单位完成后，该客户端的剩余任务便被重新插入到队列尾部。这个机制保证了客户端的整体延迟较小。
3、  服务集群管理模块。该模块使用了网络传输模块、任务流水线模块的功能，实现了跨进程的服务器ßà服务器链路。在高速局域网中，连接是快速、稳定的。因此，该模块被设计成一种星型无中心网络。任意新增服务器节点选择现有服务器集群中的任意一个节点，接入后，通过广播自动与其他服务器节点建立点对点连接。本模块只是提供一个服务器到服务器的通信隧道，不负责具体通信内容的解译。对传输内容的控制，由具体应用决定。
4、  数据库管理模块。该模块基于Qt的插件式数据库封装QtSql。数据库被作为资源管理，支持在多线程的条件下，使用数据库资源。
5、  框架界面。尽管常见的服务运行时表现为一个后台进程，但为了更好的演示服务器的功能，避免繁琐的配置，还是需要一个图形界面来显示状态、设置参数。本范例中，界面负责轮训服务器的各个状态，并设置参数。设置好的参数被存储在一个ini文件中，并在服务开启时加载。
